{"remainingRequest":"/Users/luck/shop/admin_web/node_modules/babel-loader/lib/index.js!/Users/luck/shop/admin_web/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/luck/shop/admin_web/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/luck/shop/admin_web/src/views/goods/edit.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/luck/shop/admin_web/src/views/goods/edit.vue","mtime":1585976621969},{"path":"/Users/luck/shop/admin_web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/luck/shop/admin_web/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/luck/shop/admin_web/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/luck/shop/admin_web/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["\"use strict\";\n\nvar _interopRequireDefault = require(\"/Users/luck/shop/admin_web/node_modules/@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nrequire(\"core-js/modules/es6.regexp.to-string\");\n\nrequire(\"core-js/modules/es6.regexp.split\");\n\nvar _goods = require(\"@/api/goods\");\n\nvar _storage = require(\"@/api/storage\");\n\nvar _tinymceVue = _interopRequireDefault(require(\"@tinymce/tinymce-vue\"));\n\nvar _elementUi = require(\"element-ui\");\n\nvar _auth = require(\"@/utils/auth\");\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nvar _default = {\n  name: 'GoodsEdit',\n  components: {\n    Editor: _tinymceVue.default\n  },\n  data: function data() {\n    return {\n      uploadPath: _storage.uploadPath,\n      newKeywordVisible: false,\n      newKeyword: '',\n      keywords: [],\n      galleryFileList: [],\n      categoryList: [],\n      brandList: [],\n      categoryIds: [],\n      goods: {\n        gallery: []\n      },\n      specVisiable: false,\n      specForm: {\n        specification: '',\n        picUrl: ''\n      },\n      specifications: [{\n        specification: '标准',\n        picUrl: ''\n      }],\n      productVisiable: false,\n      productForm: {\n        id: 0,\n        specifications: [],\n        number: 0,\n        url: ''\n      },\n      products: [{\n        id: 0,\n        specification: '标准',\n        number: 0,\n        url: ''\n      }],\n      attributeVisiable: false,\n      attributeAdd: true,\n      attributeForm: {\n        attribute: '',\n        value: ''\n      },\n      attributes: [],\n      rules: {\n        goodsSn: [{\n          required: true,\n          message: '商品编号不能为空',\n          trigger: 'blur'\n        }],\n        name: [{\n          required: true,\n          message: '商品名称不能为空',\n          trigger: 'blur'\n        }],\n        counterPrice: [{\n          required: true,\n          message: '原价不能为空',\n          trigger: 'blur'\n        }],\n        retailPrice: [{\n          required: true,\n          message: '实际销售价不能为空',\n          trigger: 'blur'\n        }],\n        convertScore: [{\n          required: true,\n          message: '兑换所需青豆不能为空',\n          trigger: 'blur'\n        }],\n        giveScore: [{\n          required: true,\n          message: '购买商品赠送青豆不能为空',\n          trigger: 'blur'\n        }],\n        commission: [{\n          required: true,\n          message: '购买商品返上级佣金不能为空',\n          trigger: 'blur'\n        }],\n        picUrl: [{\n          required: true,\n          message: '商品图片不能为空',\n          trigger: 'blur'\n        }],\n        gallery: [{\n          required: true,\n          message: '宣传画廊不能为空',\n          trigger: 'blur'\n        }],\n        unit: [{\n          required: true,\n          message: '商品单位不能为空',\n          trigger: 'blur'\n        }],\n        categoryId: [{\n          required: true,\n          message: '所属分类不能为空',\n          trigger: 'blur'\n        }],\n        brief: [{\n          required: true,\n          message: '所属分类不能为空',\n          trigger: 'blur'\n        }]\n      },\n      // specForm\n      specRules: {\n        specification: [{\n          required: true,\n          message: '规格名不能为空',\n          trigger: 'blur'\n        }]\n      },\n      //productForm\n      productRules: {\n        specification: [{\n          required: true,\n          message: '规格名不能为空',\n          trigger: 'blur'\n        }],\n        number: [{\n          required: true,\n          message: '货品数量不能为空',\n          trigger: 'blur'\n        }]\n      },\n      //attributeForm\n      attributeRules: {\n        attribute: [{\n          required: true,\n          message: '商品参数名称不能为空',\n          trigger: 'blur'\n        }],\n        value: [{\n          required: true,\n          message: '商品参数值不能为空',\n          trigger: 'blur'\n        }]\n      },\n      editorInit: {\n        language: 'zh_CN',\n        height: '400px',\n        convert_urls: false,\n        plugins: ['advlist anchor autolink autosave code codesample colorpicker colorpicker contextmenu directionality emoticons fullscreen hr image imagetools importcss insertdatetime link lists media nonbreaking noneditable pagebreak paste preview print save searchreplace spellchecker tabfocus table template textcolor textpattern visualblocks visualchars wordcount'],\n        toolbar: ['searchreplace bold italic underline strikethrough alignleft aligncenter alignright outdent indent  blockquote undo redo removeformat subscript superscript code codesample', 'hr bullist numlist link image charmap preview anchor pagebreak insertdatetime media table emoticons forecolor backcolor fullscreen'],\n        images_upload_handler: function images_upload_handler(blobInfo, success, failure) {\n          var formData = new FormData();\n          formData.append('file', blobInfo.blob());\n          (0, _storage.createStorage)(formData).then(function (res) {\n            success(res.data.data.url);\n          }).catch(function () {\n            failure('上传失败，请重新上传');\n          });\n        }\n      }\n    };\n  },\n  computed: {\n    headers: function headers() {\n      return {\n        'X-Litemall-Admin-Token': (0, _auth.getToken)()\n      };\n    },\n    attributesData: function attributesData() {\n      var attributesData = [];\n\n      for (var i = 0; i < this.attributes.length; i++) {\n        if (this.attributes[i].deleted) {\n          continue;\n        }\n\n        attributesData.push(this.attributes[i]);\n      }\n\n      return attributesData;\n    }\n  },\n  created: function created() {\n    this.init();\n  },\n  methods: {\n    init: function init() {\n      var _this = this;\n\n      if (this.$route.query.id == null) {\n        return;\n      }\n\n      var goodsId = this.$route.query.id;\n      (0, _goods.detailGoods)(goodsId).then(function (response) {\n        _this.goods = response.data.data.goods; // 稍微调整一下前后端不一致\n\n        if (_this.goods.brandId === 0) {\n          _this.goods.brandId = null;\n        }\n\n        if (_this.goods.keywords === '') {\n          _this.goods.keywords = null;\n        }\n\n        _this.specifications = response.data.data.specifications;\n        _this.products = response.data.data.products;\n        _this.attributes = response.data.data.attributes;\n        _this.categoryIds = response.data.data.categoryIds;\n        _this.galleryFileList = [];\n\n        for (var i = 0; i < _this.goods.gallery.length; i++) {\n          _this.galleryFileList.push({\n            url: _this.goods.gallery[i]\n          });\n        }\n\n        var keywords = response.data.data.goods.keywords;\n\n        if (keywords !== null) {\n          _this.keywords = keywords.split(',');\n        }\n      });\n      (0, _goods.listCatAndBrand)().then(function (response) {\n        _this.categoryList = response.data.data.categoryList;\n        _this.brandList = response.data.data.brandList;\n      });\n    },\n    handleCategoryChange: function handleCategoryChange(value) {\n      this.goods.categoryId = value[value.length - 1];\n    },\n    handleCancel: function handleCancel() {\n      this.$router.push({\n        path: '/goods/list'\n      });\n    },\n    handleEdit: function handleEdit() {\n      var _this2 = this;\n\n      var finalGoods = {\n        goods: this.goods,\n        specifications: this.specifications,\n        products: this.products,\n        attributes: this.attributes\n      };\n\n      if (this.specifications.length < 1) {\n        _elementUi.MessageBox.alert('请添加商品规格', '警告', {\n          confirmButtonText: '确定',\n          type: 'error'\n        });\n\n        return;\n      }\n\n      if (this.products.length < 1) {\n        _elementUi.MessageBox.alert('请添加商品库存', '警告', {\n          confirmButtonText: '确定',\n          type: 'error'\n        });\n\n        return;\n      }\n\n      this.$refs['goods'].validate(function (valid) {\n        if (valid) {\n          (0, _goods.editGoods)(finalGoods).then(function (response) {\n            _this2.$notify.success({\n              title: '成功',\n              message: '创建成功'\n            });\n\n            _this2.$router.push({\n              path: '/goods/list'\n            });\n          }).catch(function (response) {\n            _elementUi.MessageBox.alert('业务错误：' + response.data.errmsg, '警告', {\n              confirmButtonText: '确定',\n              type: 'error'\n            });\n          });\n        }\n      });\n    },\n    handleClose: function handleClose(tag) {\n      this.keywords.splice(this.keywords.indexOf(tag), 1);\n      this.goods.keywords = this.keywords.toString();\n    },\n    showInput: function showInput() {\n      var _this3 = this;\n\n      this.newKeywordVisible = true;\n      this.$nextTick(function (_) {\n        _this3.$refs.newKeywordInput.$refs.input.focus();\n      });\n    },\n    handleInputConfirm: function handleInputConfirm() {\n      var newKeyword = this.newKeyword;\n\n      if (newKeyword) {\n        this.keywords.push(newKeyword);\n        this.goods.keywords = this.keywords.toString();\n      }\n\n      this.newKeywordVisible = false;\n      this.newKeyword = '';\n    },\n    uploadPicUrl: function uploadPicUrl(response) {\n      this.goods.picUrl = response.data.url;\n    },\n    uploadOverrun: function uploadOverrun() {\n      this.$message({\n        type: 'error',\n        message: '上传文件个数超出限制!最多上传5张图片!'\n      });\n    },\n    handleGalleryUrl: function handleGalleryUrl(response, file, fileList) {\n      if (response.errno === 0) {\n        this.goods.gallery.push(response.data.url);\n      }\n    },\n    handleRemove: function handleRemove(file, fileList) {\n      for (var i = 0; i < this.goods.gallery.length; i++) {\n        // 这里存在两种情况\n        // 1. 如果所删除图片是刚刚上传的图片，那么图片地址是file.response.data.url\n        //    此时的file.url虽然存在，但是是本机地址，而不是远程地址。\n        // 2. 如果所删除图片是后台返回的已有图片，那么图片地址是file.url\n        var url;\n\n        if (file.response === undefined) {\n          url = file.url;\n        } else {\n          url = file.response.data.url;\n        }\n\n        if (this.goods.gallery[i] === url) {\n          this.goods.gallery.splice(i, 1);\n        }\n      }\n    },\n    specChanged: function specChanged(label) {\n      if (label === false) {\n        this.specifications = [{\n          specification: '规格',\n          value: '标准',\n          picUrl: ''\n        }];\n        this.products = [{\n          id: 0,\n          specifications: ['标准'],\n          number: 0,\n          url: ''\n        }];\n      } else {\n        this.specifications = [];\n        this.products = [];\n      }\n    },\n    uploadSpecPicUrl: function uploadSpecPicUrl(response) {\n      this.specForm.picUrl = response.data.url;\n    },\n    handleSpecificationShow: function handleSpecificationShow(row) {\n      this.specForm = Object.assign({}, row);\n      this.specVisiable = true;\n    },\n    handleSpecificationEdit: function handleSpecificationEdit() {\n      var _this4 = this;\n\n      this.$refs['specForm'].validate(function (valid) {\n        if (valid) {\n          _this4.specForm.updateTime = '';\n\n          for (var i = 0; i < _this4.specifications.length; i++) {\n            var v = _this4.specifications[i];\n\n            if (v.id === _this4.specForm.id) {\n              _this4.specifications.splice(i, 1, _this4.specForm);\n\n              break;\n            }\n          }\n\n          for (var i = 0; i < _this4.products.length; i++) {\n            var _v = _this4.products[i];\n\n            if (_v.specificationId === _this4.specForm.id) {\n              _v.specification = _this4.specForm.specification;\n\n              _this4.products.splice(i, 1, _v);\n\n              break;\n            }\n          }\n\n          _this4.specVisiable = false;\n        }\n      });\n    },\n    handleProductShow: function handleProductShow(row) {\n      this.productForm = Object.assign({}, row);\n      this.productVisiable = true;\n    },\n    uploadProductUrl: function uploadProductUrl(response) {\n      this.productForm.url = response.data.url;\n    },\n    handleProductEdit: function handleProductEdit() {\n      var _this5 = this;\n\n      this.$refs['productForm'].validate(function (valid) {\n        if (valid) {\n          _this5.productForm.updateTime = '';\n\n          for (var i = 0; i < _this5.products.length; i++) {\n            var v = _this5.products[i];\n\n            if (v.id === _this5.productForm.id) {\n              _this5.products.splice(i, 1, _this5.productForm);\n\n              break;\n            }\n          }\n\n          _this5.productVisiable = false;\n        }\n      });\n    },\n    handleAttributeShow: function handleAttributeShow(row) {\n      if (row.id) {\n        this.attributeForm = Object.assign({}, row);\n        this.attributeAdd = false;\n      } else {\n        this.attributeForm = {};\n        this.attributeAdd = true;\n      }\n\n      this.attributeVisiable = true;\n    },\n    handleAttributeAdd: function handleAttributeAdd() {\n      this.attributes.unshift(this.attributeForm);\n      this.attributeVisiable = false;\n    },\n    handleAttributeEdit: function handleAttributeEdit() {\n      var _this6 = this;\n\n      this.$refs['attributeForm'].validate(function (valid) {\n        if (valid) {\n          // 这是一个trick，设置updateTime的值为空，告诉后端这个记录已编辑需要更新。\n          _this6.attributeForm.updateTime = '';\n\n          for (var i = 0; i < _this6.attributes.length; i++) {\n            var v = _this6.attributes[i];\n\n            if (v.id === _this6.attributeForm.id) {\n              _this6.attributes.splice(i, 1, _this6.attributeForm);\n\n              break;\n            }\n          }\n\n          _this6.attributeVisiable = false;\n        }\n      });\n    },\n    handleAttributeDelete: function handleAttributeDelete(row) {\n      row.deleted = true;\n    }\n  }\n};\nexports.default = _default;",null]}